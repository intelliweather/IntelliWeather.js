/*!
 * IntelliWeather.js 0.1.0-beta
 * http://www.intelliweather.com
 * Copyright 2014 IntelliWeather, Inc.
 */

!function(t){var e=function(){"use strict";return{extend:t.extend,expandUrl:function(t,e){for(var i in e)t=t.replace("{"+i+"}",e[i]);return t},isNull:function(t){return null===t},isUndefined:function(t){return"undefined"==typeof t},isFunction:t.isFunction,isObject:t.isPlainObject,isBool:function(t){return"boolean"==typeof t},isNumber:function(t){return"number"==typeof t},isString:function(t){return"string"==typeof t},isArray:t.isArray,has:function(t,e){return null!=t&&Object.prototype.hasOwnProperty.call(t,e)},padZeroes:function(t){for(t=t.toString();t.length<2;)t="0"+t;return t},toAbbRelativeTime:function(t){var e=Math.abs(t/1e3),i=Math.floor(e/86400);e%=86400;var s=Math.floor(e/3600);e%=3600;var n=Math.floor(e/60);return e%=60,this.padZeroes(i)+"d "+this.padZeroes(s)+"h "+this.padZeroes(n)+"m"+(0>t?" ago":" from now")}}}(),i=function(){"use strict";return{iwTopBar:{fontFamily:'"Tahoma", "Century Gothic", "Helvetica Neue", Helvetica, Arial',fontSize:"12px",fontWeight:"bold",width:"100%",zIndex:"100",position:"absolute",top:"0px",padding:"8px",paddingBottom:"0px",color:"white",textShadow:"-1px 1px 5px #000, 1px -1px 5px #000"},iwTime:{position:"absolute",top:"8px",right:"23px"},iwControls:{paddingTop:"8px",textAlign:"center",fontSize:"16px",textShadow:"2px 2px 6px black"},iwPrevious:{cursor:"pointer",padding:"8px",paddingLeft:"20px",paddingRight:"50px"},iwNext:{cursor:"pointer",padding:"8px",paddingLeft:"50px",paddingRight:"20px"},iwPausePlay:{cursor:"pointer",padding:"8px",paddingLeft:"50px",paddingRight:"50px"},overlay:{position:"fixed",zIndex:"500",top:"0px",left:"0px",height:"100%",width:"100%",background:"#000",display:"none"},modal:{display:"none",position:"fixed",opacity:"0",zIndex:"11000",left:"50%"}}}(),s=function(){"use strict";return{topBar:'<div class="iw-topbar"></div>',seriesTitle:'<span class="iw-title"></span>',subTitle:'<span class="iw-subtitle"></span>',labelFrame:'<span class="iw-frame-index"></span>',labelTime:'<span class="iw-time"></span>',controls:'<div class="iw-controls"></div>',previousControl:'<i class="iw-prev fa fa-backward fa-2x"></i>',pausePlayControl:'<i class="iw-pauseplay fa fa-pause fa-2x"></i>',nextControl:'<i class="iw-next fa fa-forward fa-2x"></i>',overlay:'<div id="overlay"></div>'}}(),n=function(){"use strict";function n(n){var r=this;this.settings=e.extend({},this._defaults,n),this.$overlay=t(s.overlay).css(i.overlay),t("body").append(this.$overlay),this.$anchor=this.settings.anchor,this.$anchor.click(function(t){r._anchorClicked(this,t),t.preventDefault()}),this.listeners={}}return e.extend(n.prototype,{_fire:function(t,e){if("string"==typeof t&&(t={type:t}),t.target||(t.target=this),!t.type)throw new Error('Event object missing "type" property.');if(this.listeners[t.type]instanceof Array)for(var i=this.listeners[t.type],s=0,n=i.length;n>s;s++){var r=i[s];r.callback.call(r.context,e)}},_close:function(e){this.$overlay.fadeOut(200),t(e).css({display:"none"})},_anchorClicked:function(s){var n=t(s).attr("href"),r=this;this.$overlay.click(function(){r._close(n)});var a=t(n),o=(a.outerHeight(),a.outerWidth());this.$overlay.css({display:"block",opacity:0}),this.$overlay.fadeTo(200,this.settings.overlay),a.css(e.extend({},i.modal,{display:"block",marginLeft:-(o/2)+"px",top:this.settings.top+"px"})),a.fadeTo(200,1),this._fire("onComplete",a)},_defaults:{top:100,overlay:.5},addListener:function(t,e,i){"undefined"==typeof this.listeners[t]&&(this.listeners[t]=[]),this.listeners[t].push({context:e,callback:i})}}),n}(),r=function(){"use strict";function n(i){this.settings=e.extend({},this._defaults,i),this.$container=this.settings.container,this.slides=this.$container.find("img"),this.currentSlide=0,this.timer=0,this.listeners={},this.state="paused",this._setupControls(),this.currentSlide=this.settings.startSlide,(this.settings.startSlide<0||this.settings.startSlide>=this.slides.length)&&(this.currentSlide=0),t(this.slides[this.currentSlide]).css({display:"block"})}return e.extend(n.prototype,{_setupControls:function(){if(this.slides.length>1&&this.settings.controlArea&&this.$container.find(this.settings.controlArea).length){this.$controls=t(s.controls).css(i.iwControls),this.$previousControl=t(s.previousControl).css(i.iwPrevious).appendTo(this.$controls),this.$pausePlayControl=t(s.pausePlayControl).css(i.iwPausePlay).appendTo(this.$controls),this.$nextControl=t(s.nextControl).css(i.iwNext).appendTo(this.$controls);var e=this;this.$previousControl.click(function(){e.pause(),e.prev()}),this.$pausePlayControl.click(function(){"paused"==e.state?e.play():e.pause()}),this.$nextControl.click(function(){e.pause(),e.next()}),this.$container.find(this.settings.controlArea).append(this.$controls)}},_fire:function(t,e){if("string"==typeof t&&(t={type:t}),t.target||(t.target=this),!t.type)throw new Error('Event object missing "type" property.');if(this.listeners[t.type]instanceof Array)for(var i=this.listeners[t.type],s=0,n=i.length;n>s;s++){var r=i[s];r.callback.call(r.context,e)}},_doTimer:function(){if(this.settings.pauseTime&&this.settings.pauseTime>0){clearTimeout(this.timer);var t=this;this.timer=setTimeout(function(){t.next()},this.settings.pauseTime)}},_defaults:{pauseTime:700,pauseOnHover:!0,startSlide:0},destroy:function(){clearTimeout(this.timer)},prev:function(){this.currentSlide--,this.currentSlide<0&&(this.currentSlide=this.slides.length-1),this.slides.css({display:"none"});var e=t(this.slides[this.currentSlide]);e.css({display:"block"}),this._fire("slideChanged",e),"play"===this.state&&this._doTimer()},next:function(){this.currentSlide++,this.currentSlide>=this.slides.length&&(this.currentSlide=0),this.slides.css({display:"none"});var e=t(this.slides[this.currentSlide]);e.css({display:"block"}),this._fire("slideChanged",e),"play"===this.state&&this._doTimer()},pause:function(){"play"===this.state&&this.slides.length>1&&(clearTimeout(this.timer),this.state="paused",this.$pausePlayControl.removeClass("fa-pause"),this.$pausePlayControl.addClass("fa-play"))},play:function(){"paused"===this.state&&this.slides.length>1&&(this.state="play",this.$pausePlayControl.removeClass("fa-play"),this.$pausePlayControl.addClass("fa-pause"),this._doTimer())},addListener:function(t,e,i){"undefined"==typeof this.listeners[t]&&(this.listeners[t]=[]),this.listeners[t].push({context:e,callback:i})}}),n}(),a=function(){"use strict";function i(t,e){return decodeURIComponent(e?t.replace(/\+/g," "):t)}function s(t){return encodeURIComponent(t)}function n(t,i){if(!i)return t;var s=t.indexOf("?");return 0>s&&t.indexOf("=")<0||(i=e.mixin(!0,{},a(t.substr(s+1)),i),t=t.substr(0,s)),t+"?"+r(i)}function r(i,s,n,a){var o=[];if(s=s||"&",n=n||"=",e.isNull(i)||e.isUndefined(i)||e.isFunction(i))return a?encodeURIComponent(a)+n:"";if(e.isBool(i)&&(i=i?"true":"false"),e.isNumber(i)||e.isString(i))return encodeURIComponent(a)+n+encodeURIComponent(i);var l;if(e.isArray(i))return l=[],l.push(r(i.join(","),s,n,a)),l.join(s);for(var d=o.length-1;d>=0;--d)o[d]===i&&t.error("QueryString.stringify. Cyclical reference");o.push(i),l=[];var h=a?a+"[":"",p=a?"]":"";for(var c in i)if(e.has(i,c)){var u=h+c+p;l.push(r(i[c],s,n,u))}return o.pop(),l=l.join(s),!l&&a?a+"=":l}function a(t,i,s){return e.reduce(e.map(t.split(i||"&"),o(s||"=")),l)}function o(t){return function s(n,r){var a;if(2!==arguments.length)return n=n.split(t),s(i(n.shift(),!0),i(n.join(t),!0));if(n=n.replace(/^\s+|\s+$/g,""),e.isString(r)&&(r=r.replace(/^\s+|\s+$/g,""),!isNaN(r))){var o=+r;r===o.toString(10)&&(r=o)}var l=/(.*)\[([^\]]*)\]$/.exec(n);if(!l)return a={},n&&(a[n]=r),a;var d=l[2],h=l[1];return d?(a={},a[d]=r,s(h,a)):s(h,[r])}}function l(t,i){return t?e.isArray(t)?t.concat(i):e.isObject(t,{})&&e.isObject(i,{})?d(t,i):[t].concat(i):i}function d(t,i){for(var s in i)s&&e.has(i,s)&&(t[s]=l(t[s],i[s]));return t}return{unescape:i,escape:s,addQuery:n}}(),o=function(){"use strict";function i(t){this.descriptor=t,this.listeners={}}var s=this;return e.extend(i.prototype,{_error:function(){},_schedule:function(){if(this.descriptor.poll&&(new Date-this.startedPollAt)/1e3<this.descriptor.pollDuration){var t=this;setTimeout(function(){t.start()},1e3*this.descriptor.pollInterval)}},_fire:function(t,e){if("string"==typeof t&&(t={type:t}),t.target||(t.target=this),!t.type)throw new Error('Event object missing "type" property.');if(this.listeners[t.type]instanceof Array)for(var i=this.listeners[t.type],s=0,n=i.length;n>s;s++){var r=i[s];r.callback.call(r.context,e)}},_datasetChanged:function(t){var e=this.dataset;this.dataset=t;var i=null!=e;return i&&(i=t.length==e.length),t.length>0&&(i&&(i=t[0].id==e[0].id),i&&(i=t[t.length-1].id==e[e.length-1].id)),i?!1:!0},_success:function(t){this._datasetChanged(t)&&this._fire("datasetChanged",t),this._schedule()},_buildDataset:function(t){var i={description:t.description||"",width:t.width||640,height:t.height||480,format:t.format||"jpg"},n=0,r=t.batch===!0?t.lastSequence:t.last,a=[];for(n=this.descriptor.series?this.descriptor.seriesLength||t.maxItems||s.descriptor.defaultSequenceLength:1;a.length<n;){var o={id:r};e.extend(o,t.images[r]),a.push(o),r--}return a.reverse(),i.images=a,i},_getChannelMeta:function(){var i="https://s3-us-west-1.amazonaws.com/iw-metadata/channels/{channel}.js";return i=e.expandUrl(i,this.descriptor),t.ajax(i,{type:"GET",dataType:"json",cache:!1,context:this})},start:function(){this.startedPollAt=new Date,this._getChannelMeta().pipe(this._buildDataset).done(this._success).fail(this._error)},addListener:function(t,e,i){"undefined"==typeof this.listeners[t]&&(this.listeners[t]=[]),this.listeners[t].push({context:e,callback:i})}}),i}(),l=function(){"use strict";function l(t){t=t||{},this.$container=t.container,this.descriptor=e.extend({},this._defaults,t.descriptor),this.$images=[],this.slider=null,this.$container.css({width:this.descriptor.displayWidth,height:this.descriptor.displayHeight});var i=new o(this.descriptor);i.addListener("datasetChanged",this,this._render),i.start()}return e.extend(l.prototype,{_modalCompleted:function(t){var i=e.extend({},this.descriptor.expand);t.intelliWeather({local:i})},_formatTimestamp:function(t){var i=e.padZeroes(t.getMonth()+1),s=e.padZeroes(t.getDate()),n=t.getFullYear(),r=e.padZeroes(t.getHours()),a=e.padZeroes(t.getMinutes());return i+"/"+s+"/"+n+" "+r+":"+a+" "+this.descriptor.timeZone.toUpperCase()},_updateTopBar:function(t){var i=t.data("timestamp")||"";this.$seriesTitle.text(this.dataset.description||""),this.$subTitle.text(" - "+e.toAbbRelativeTime(i-Date.now())),this.$labelFrame.text(" "+e.padZeroes(t.data("index")+1)+" of "+this.dataset.images.length),this.$labelTime.html(this._formatTimestamp(t.data("timestamp")))},_renderImages:function(s){var r=this;t.each(s.images,function(a,o){var l=r.$images[o.id];if(r.descriptor.series&&s.images.length>1)r.$container.append(l);else{var d=t("<div></div>").attr("id","modal-"+o.id).css(e.extend({},i.modal,{width:r.descriptor.expand.displayWidth,height:r.descriptor.expand.displayHeight}));d.addClass("iw"),t("body").append(d);var h=t("<a></a>").attr("href","#modal-"+o.id);h.append(l),r.$container.append(h);var p=new n({anchor:h,top:200});p.addListener("onComplete",r,r._modalCompleted)}})},_renderTopBar:function(){if(this.descriptor.series){this.$topbar=t(s.topBar).css(i.iwTopBar),this.$seriesTitle=t(s.seriesTitle).appendTo(this.$topbar),this.$subTitle=t(s.subTitle).appendTo(this.$topbar),this.$labelFrame=t(s.labelFrame).appendTo(this.$topbar),this.$labelTime=t(s.labelTime).appendTo(this.$topbar).css(i.iwTime),this.$container.append(this.$topbar);var e=this.$images[this.dataset.images[0].id];this._updateTopBar(e)}},_preloadImages:function(i,s){var n=t.Deferred(),r=[],a=this;return t.each(s.images,function(n,o){var l=e.expandUrl(i,e.extend(a.descriptor,s,o)),d=t.Deferred(),h=t("<img />").attr("id",o.id).attr("src",l);h.data("index",n),h.data("timestamp",new Date(o.time)),h.css({display:"none"}),h.load(function(){d.resolveWith(a)}),a.$images[o.id]=h,r.push(d.promise())}),t.when.apply(t,r).done(function(){n.resolveWith(a)}),n},_render:function(t){this.destroy(),this.dataset=t;var i=Math.min(this.descriptor.displayWidth||t.width),s=Math.min(this.descriptor.displayHeight||t.height),n=a.addQuery(this.descriptor.imagePath,e.extend({},this.descriptor.commands,{width:i,height:s}));this._preloadImages(n,t).done(function(){this._renderTopBar(),this._renderImages(t),this.slider=new r({container:this.$container,controlArea:".iw-topbar"}),this.slider.addListener("slideChanged",this,this._updateTopBar),this.slider.play()})},_defaults:{imageHost:"https://gfx1.intelliweather.net",imagePath:"{imageHost}/c/{channel}/{id}.{format}",defaultSequenceLength:12,pollInterval:60,pollDuration:600,poll:!0},destroy:function(){this.$container.empty(),this.dataset=null,this.$images=[],this.slider&&(this.slider.destroy(),this.slider=null)}}),l}();!function(){"use strict";var i,s="iw";i={initialize:function(i){function n(){console.log("failed retrieving the remote descriptor")}function r(){var t=e.isObject(i.remote)?i.remote:{},n=e.extend({},i.local,t),r=new l({container:d,descriptor:n});d.data(s,r)}function a(e){function i(t){e.remote=t}var s;return s=e.remote?t.ajax(e.remote,{type:"GET",dataType:"json",context:this}).done(i):t.Deferred().resolve()}function o(){a(i).done(r).fail(n)}var d=t(this);return this.each(o)}},t.fn.intelliWeather=function(){return i.initialize.apply(this,arguments)}}()}(window.jQuery);